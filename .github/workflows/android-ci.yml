name: Build Flutter Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: ‚òï Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîß Configure Java Home for Gradle
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "Java Home: $JAVA_HOME"
          echo "Java Version: $(java -version 2>&1 | head -n 1)"
          
      - name: üê¶ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üì¶ Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
          
      - name: üìã Flutter doctor
        run: flutter doctor -v
        
      - name: üì¶ Get dependencies
        run: |
          flutter pub get
          flutter pub deps

      - name: üîß Clean build
        run: flutter clean

      - name: üîß Fix plugin namespace, manifest, and JVM compatibility issues
        run: |
          # Fix on_audio_query_android plugin
          PLUGIN_DIR="$HOME/.pub-cache/hosted/pub.dev/on_audio_query_android-1.1.0/android"
          if [ -d "$PLUGIN_DIR" ]; then
            echo "Fixing on_audio_query_android plugin..."

            # Add namespace to build.gradle if missing
            if ! grep -q "namespace" "$PLUGIN_DIR/build.gradle"; then
              sed -i '/android {/a\    namespace "com.lucasjosino.on_audio_query_android"' "$PLUGIN_DIR/build.gradle"
              echo "‚úÖ Namespace added to build.gradle"
            fi

            # Fix JVM target compatibility
            if ! grep -q "jvmTarget.*17" "$PLUGIN_DIR/build.gradle"; then
              # Add or update compileOptions
              if ! grep -q "compileOptions" "$PLUGIN_DIR/build.gradle"; then
                sed -i '/namespace/a\    compileOptions {\n        sourceCompatibility JavaVersion.VERSION_17\n        targetCompatibility JavaVersion.VERSION_17\n    }' "$PLUGIN_DIR/build.gradle"
              fi

              # Add or update kotlinOptions
              if ! grep -q "kotlinOptions" "$PLUGIN_DIR/build.gradle"; then
                sed -i '/compileOptions/,/}/a\    kotlinOptions {\n        jvmTarget = "17"\n    }' "$PLUGIN_DIR/build.gradle"
              else
                sed -i 's/jvmTarget = "[^"]*"/jvmTarget = "17"/' "$PLUGIN_DIR/build.gradle"
              fi
              echo "‚úÖ JVM target compatibility fixed (Java 17 + Kotlin 17)"
            fi

            # Remove package attribute from AndroidManifest.xml
            MANIFEST_FILE="$PLUGIN_DIR/src/main/AndroidManifest.xml"
            if [ -f "$MANIFEST_FILE" ]; then
              if grep -q 'package=' "$MANIFEST_FILE"; then
                sed -i 's/package="[^"]*"//g' "$MANIFEST_FILE"
                sed -i 's/<manifest[^>]*>/<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android">/' "$MANIFEST_FILE"
                echo "‚úÖ Package attribute removed from AndroidManifest.xml"
              fi
            fi

            echo "‚úÖ on_audio_query_android plugin fully fixed"
          fi

          # Fix other potential plugins with similar issues
          find "$HOME/.pub-cache/hosted/pub.dev" -name "build.gradle" -path "*/android/build.gradle" | while read gradle_file; do
            plugin_dir=$(dirname "$gradle_file")
            plugin_name=$(basename "$(dirname "$plugin_dir")")

            if [[ "$plugin_name" == *"audio"* ]] || [[ "$plugin_name" == *"permission"* ]]; then
              echo "Fixing plugin: $plugin_name"

              # Add namespace if missing
              if ! grep -q "namespace" "$gradle_file"; then
                namespace="com.example.${plugin_name}"
                sed -i "/android {/a\\    namespace \"$namespace\"" "$gradle_file"
                echo "‚úÖ Fixed namespace for $plugin_name"
              fi

              # Fix JVM target compatibility and kotlinOptions issues
              if ! grep -q "jvmTarget.*17" "$gradle_file"; then
                # Add compileOptions if missing
                if ! grep -q "compileOptions" "$gradle_file"; then
                  sed -i '/android {/a\    compileOptions {\n        sourceCompatibility JavaVersion.VERSION_17\n        targetCompatibility JavaVersion.VERSION_17\n    }' "$gradle_file"
                fi

                # Fix kotlinOptions placement - should be in android block, not compileOptions
                if grep -q "compileOptions.*kotlinOptions" "$gradle_file"; then
                  # Remove kotlinOptions from compileOptions
                  sed -i '/compileOptions/,/}/ { /kotlinOptions/,/}/d; }' "$gradle_file"
                fi

                # Add kotlinOptions correctly in android block
                if ! grep -q "kotlinOptions" "$gradle_file"; then
                  sed -i '/compileOptions/,/}/a\    kotlinOptions {\n        jvmTarget = "17"\n    }' "$gradle_file"
                else
                  sed -i 's/jvmTarget = "[^"]*"/jvmTarget = "17"/' "$gradle_file"
                fi
                echo "‚úÖ Fixed JVM target for $plugin_name"
              fi

              # Fix manifest
              manifest_file="$plugin_dir/src/main/AndroidManifest.xml"
              if [ -f "$manifest_file" ] && grep -q 'package=' "$manifest_file"; then
                sed -i 's/package="[^"]*"//g' "$manifest_file"
                echo "‚úÖ Fixed manifest for $plugin_name"
              fi
            fi
          done

          # Special fix for audio_service plugin kotlinOptions issue (multiple versions)
          find "$HOME/.pub-cache/hosted/pub.dev" -name "build.gradle" -path "*audio_service*/android/build.gradle" | while read audio_gradle; do
            plugin_version=$(basename "$(dirname "$(dirname "$audio_gradle")")")
            echo "Applying special fix for $plugin_version..."

            # Check if the file has the problematic kotlinOptions in compileOptions
            if grep -A 10 "compileOptions" "$audio_gradle" | grep -q "kotlinOptions"; then
              echo "Found kotlinOptions in compileOptions block, fixing..."

              # Create a temporary file with the fix
              temp_file=$(mktemp)

              # Process the file to remove kotlinOptions from compileOptions and add it correctly
              awk '
                /compileOptions/ { in_compile_options = 1; print; next }
                in_compile_options && /kotlinOptions/ {
                  in_kotlin_options = 1
                  kotlin_options_content = ""
                  next
                }
                in_compile_options && in_kotlin_options && /}/ {
                  in_kotlin_options = 0
                  next
                }
                in_compile_options && in_kotlin_options {
                  kotlin_options_content = kotlin_options_content $0 "\n"
                  next
                }
                in_compile_options && /}/ {
                  in_compile_options = 0
                  print
                  if (kotlin_options_content != "") {
                    print "    kotlinOptions {"
                    printf "%s", kotlin_options_content
                    print "    }"
                  }
                  next
                }
                { print }
              ' "$audio_gradle" > "$temp_file"

              # Replace the original file
              mv "$temp_file" "$audio_gradle"
              echo "‚úÖ Fixed $plugin_version kotlinOptions placement"
            else
              echo "No kotlinOptions issues found in $plugin_version"
            fi
          done

      - name: üîç Analyze code
        run: flutter analyze

      - name: üß™ Run tests
        run: flutter test
        
      - name: üîê Decode keystore (Release only)
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          echo "Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          echo "Keystore decoded. File size: $(wc -c < android/app/upload-keystore.jks) bytes"

      - name: üîë Create key.properties (Release only)
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          cat <<EOF > android/key.properties
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=app/upload-keystore.jks
          EOF

      - name: üîç Debug keystore setup
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          echo "Checking keystore and key.properties setup..."
          ls -la android/
          ls -la android/app/
          echo "Contents of key.properties:"
          cat android/key.properties
          echo "Keystore file exists:"
          test -f android/app/upload-keystore.jks && echo "‚úÖ Keystore found" || echo "‚ùå Keystore missing"

      - name: üèóÔ∏è Build Release APK
        if: github.event.inputs.build_type != 'debug'
        run: flutter build apk --release --verbose

      - name: üèóÔ∏è Build Debug APK
        if: github.event.inputs.build_type == 'debug'
        run: flutter build apk --debug --verbose

      - name: üì± Upload Release APK
        if: github.event.inputs.build_type != 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: offmusic-release-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: üì± Upload Debug APK
        if: github.event.inputs.build_type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: offmusic-debug-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7
          
      - name: üìä APK Info
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "Release APK size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
            echo "Release APK path: build/app/outputs/flutter-apk/app-release.apk"
          fi
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "Debug APK size: $(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)"
            echo "Debug APK path: build/app/outputs/flutter-apk/app-debug.apk"
          fi
