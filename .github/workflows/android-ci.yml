name: Build Flutter Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: ğŸ¦ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
          
      - name: ğŸ“‹ Flutter doctor
        run: flutter doctor -v
        
      - name: ğŸ“¦ Get dependencies
        run: |
          flutter pub get
          flutter pub deps

      - name: ğŸ”§ Clean build
        run: flutter clean

      - name: ğŸ”§ Fix plugin namespace and manifest issues
        run: |
          # Fix on_audio_query_android plugin
          PLUGIN_DIR="$HOME/.pub-cache/hosted/pub.dev/on_audio_query_android-1.1.0/android"
          if [ -d "$PLUGIN_DIR" ]; then
            echo "Fixing on_audio_query_android plugin..."

            # Add namespace to build.gradle if missing
            if ! grep -q "namespace" "$PLUGIN_DIR/build.gradle"; then
              sed -i '/android {/a\    namespace "com.lucasjosino.on_audio_query_android"' "$PLUGIN_DIR/build.gradle"
              echo "âœ… Namespace added to build.gradle"
            fi

            # Remove package attribute from AndroidManifest.xml
            MANIFEST_FILE="$PLUGIN_DIR/src/main/AndroidManifest.xml"
            if [ -f "$MANIFEST_FILE" ]; then
              if grep -q 'package=' "$MANIFEST_FILE"; then
                sed -i 's/package="[^"]*"//g' "$MANIFEST_FILE"
                sed -i 's/<manifest[^>]*>/<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android">/' "$MANIFEST_FILE"
                echo "âœ… Package attribute removed from AndroidManifest.xml"
              fi
            fi

            echo "âœ… on_audio_query_android plugin fixed"
          fi

          # Fix other potential plugins with similar issues
          find "$HOME/.pub-cache/hosted/pub.dev" -name "build.gradle" -path "*/android/build.gradle" | while read gradle_file; do
            plugin_dir=$(dirname "$gradle_file")
            plugin_name=$(basename "$(dirname "$plugin_dir")")

            if [[ "$plugin_name" == *"audio"* ]] || [[ "$plugin_name" == *"permission"* ]]; then
              if ! grep -q "namespace" "$gradle_file"; then
                namespace="com.example.${plugin_name}"
                sed -i "/android {/a\\    namespace \"$namespace\"" "$gradle_file"
                echo "âœ… Fixed namespace for $plugin_name"
              fi

              manifest_file="$plugin_dir/src/main/AndroidManifest.xml"
              if [ -f "$manifest_file" ] && grep -q 'package=' "$manifest_file"; then
                sed -i 's/package="[^"]*"//g' "$manifest_file"
                echo "âœ… Fixed manifest for $plugin_name"
              fi
            fi
          done

      - name: ğŸ” Analyze code
        run: flutter analyze

      - name: ğŸ§ª Run tests
        run: flutter test
        
      - name: ğŸ” Decode keystore (Release only)
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          echo "Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          echo "Keystore decoded. File size: $(wc -c < android/app/upload-keystore.jks) bytes"

      - name: ğŸ”‘ Create key.properties (Release only)
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          cat <<EOF > android/key.properties
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=app/upload-keystore.jks
          EOF

      - name: ğŸ” Debug keystore setup
        if: env.KEYSTORE_BASE64 != '' && (github.event.inputs.build_type != 'debug')
        run: |
          echo "Checking keystore and key.properties setup..."
          ls -la android/
          ls -la android/app/
          echo "Contents of key.properties:"
          cat android/key.properties
          echo "Keystore file exists:"
          test -f android/app/upload-keystore.jks && echo "âœ… Keystore found" || echo "âŒ Keystore missing"

      - name: ğŸ—ï¸ Build Release APK
        if: github.event.inputs.build_type != 'debug'
        run: flutter build apk --release --verbose

      - name: ğŸ—ï¸ Build Debug APK
        if: github.event.inputs.build_type == 'debug'
        run: flutter build apk --debug --verbose

      - name: ğŸ“± Upload Release APK
        if: github.event.inputs.build_type != 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: offmusic-release-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ğŸ“± Upload Debug APK
        if: github.event.inputs.build_type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: offmusic-debug-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7
          
      - name: ğŸ“Š APK Info
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "Release APK size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
            echo "Release APK path: build/app/outputs/flutter-apk/app-release.apk"
          fi
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "Debug APK size: $(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)"
            echo "Debug APK path: build/app/outputs/flutter-apk/app-debug.apk"
          fi
